import io
import json
import os

from reportlab.lib import colors
from reportlab.lib.pagesizes import A4
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont
from reportlab.platypus import (
    HRFlowable,
    Paragraph,
    SimpleDocTemplate,
    Spacer,
    Table,
    TableStyle,
)

from localization import get_text_by_lang


def register_fonts():
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —à—Ä–∏—Ñ—Ç–æ–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫–∏—Ä–∏–ª–ª–∏—Ü—ã"""
    font_name = 'Helvetica' # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —à—Ä–∏—Ñ—Ç (–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–∏—Ä–∏–ª–ª–∏—Ü—É)
    
    # –ü—É—Ç–∏ –∫ —à—Ä–∏—Ñ—Ç–∞–º (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –ª–æ–∫–∞–ª—å–Ω–∞—è –ø–∞–ø–∫–∞ -> —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø—É—Ç–∏ Linux)
    possible_paths = [
        'fonts/DejaVuSans.ttf',
        'DejaVuSans.ttf',
        '/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf',
        '/usr/share/fonts/TTF/DejaVuSans.ttf'
    ]
    
    for path in possible_paths:
        if os.path.exists(path):
            try:
                pdfmetrics.registerFont(TTFont('DejaVuSans', path))
                font_name = 'DejaVuSans'
                break
            except Exception:
                continue
                
    return font_name

def generate_resume_pdf(user_data, lang='ru'):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF —Ä–µ–∑—é–º–µ"""
    buffer = io.BytesIO()
    doc = SimpleDocTemplate(
        buffer,
        pagesize=A4,
        rightMargin=40, leftMargin=40,
        topMargin=40, bottomMargin=40
    )
    
    font_name = register_fonts()
    styles = getSampleStyleSheet()
    
    # –°—Ç–∏–ª–∏
    style_title = ParagraphStyle(
        'ResumeTitle', 
        parent=styles['Heading1'], 
        fontName=font_name, 
        fontSize=24, 
        spaceAfter=20, 
        textColor=colors.darkblue
    )
    style_heading = ParagraphStyle(
        'ResumeHeading', 
        parent=styles['Heading2'], 
        fontName=font_name, 
        fontSize=14, 
        spaceBefore=15, 
        spaceAfter=10,
        textColor=colors.HexColor('#2c3e50'),
        borderPadding=(0, 0, 5, 0) # –õ–∏–Ω–∏—è —Å–Ω–∏–∑—É
    )
    style_body = ParagraphStyle(
        'ResumeBody', 
        parent=styles['Normal'], 
        fontName=font_name, 
        fontSize=10, 
        leading=14
    )
    style_small = ParagraphStyle(
        'ResumeSmall', 
        parent=styles['Normal'], 
        fontName=font_name, 
        fontSize=9, 
        textColor=colors.grey
    )

    story = []

    # --- –ó–∞–≥–æ–ª–æ–≤–æ–∫ (–ò–º—è) ---
    full_name = user_data.get('full_name', 'Candidate')
    story.append(Paragraph(full_name, style_title))
    
    # --- –ö–æ–Ω—Ç–∞–∫—Ç—ã ---
    contact_data = [
        [f"üìû {user_data.get('phone', '')}", f"üìß {user_data.get('email', '')}"],
        [f"üèô {user_data.get('city', '')}", f"üìÖ {user_data.get('age', '')} –ª–µ—Ç/years"]
    ]
    t = Table(contact_data, colWidths=[250, 250])
    t.setStyle(TableStyle([
        ('FONTNAME', (0,0), (-1,-1), font_name),
        ('TEXTCOLOR', (0,0), (-1,-1), colors.darkgrey),
        ('BOTTOMPADDING', (0,0), (-1,-1), 10),
    ]))
    story.append(t)
    story.append(HRFlowable(width="100%", thickness=1, color=colors.lightgrey, spaceBefore=5, spaceAfter=15))

    # --- –ü—Ä–æ—Ñ–µ—Å—Å–∏—è ---
    prof = user_data.get('profession', '')
    # –ü–µ—Ä–µ–≤–æ–¥–∏–º, –µ—Å–ª–∏ —ç—Ç–æ –∫–ª—é—á
    if prof and prof.startswith('prof_'):
        prof = get_text_by_lang(prof, lang)
    story.append(Paragraph("–ü–†–û–§–ï–°–°–ò–Ø / PROFESSION", style_heading))
    story.append(Paragraph(prof, style_body))

    # --- –û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã ---
    story.append(Paragraph("–û–ü–´–¢ –†–ê–ë–û–¢–´ / EXPERIENCE", style_heading))
    story.append(Paragraph(user_data.get('experience', '–ù–µ—Ç –æ–ø—ã—Ç–∞'), style_body))

    # --- –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ ---
    story.append(Paragraph("–û–ë–†–ê–ó–û–í–ê–ù–ò–ï / EDUCATION", style_heading))
    story.append(Paragraph(user_data.get('education', '–ù–µ —É–∫–∞–∑–∞–Ω–æ'), style_body))

    # --- –ù–∞–≤—ã–∫–∏ ---
    story.append(Paragraph("–ù–ê–í–´–ö–ò / SKILLS", style_heading))
    story.append(Paragraph(user_data.get('skills', '–ù–µ —É–∫–∞–∑–∞–Ω—ã'), style_body))

    # --- –Ø–∑—ã–∫–∏ ---
    langs = user_data.get('languages', '–ù–µ —É–∫–∞–∑–∞–Ω—ã')
    try:
        if isinstance(langs, str) and langs.startswith('['):
            l_list = json.loads(langs)
            parts = []
            for item in l_list:
                name = item.get('lang_name') or item.get('lang_key', 'Unknown')
                level = item.get('level_key', '')
                parts.append(f"{name} - {level}")
            langs = ", ".join(parts)
    except:
        pass
        
    story.append(Paragraph("–Ø–ó–´–ö–ò / LANGUAGES", style_heading))
    story.append(Paragraph(langs, style_body))

    # --- Footer ---
    story.append(Spacer(1, 30))
    story.append(Paragraph(f"Generated by Telegram Job Bot ‚Ä¢ {user_data.get('phone', '')}", style_small))

    doc.build(story)
    buffer.seek(0)
    return buffer